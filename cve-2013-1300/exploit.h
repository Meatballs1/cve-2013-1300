#include <Windows.h>
#include <stdio.h>
#pragma comment(lib, "user32")
#pragma comment(lib, "kernel32")

typedef struct _EPROCESS_QUOTA_ENTRY
{
	ULONG      Usage;
	ULONG      Limit;
	ULONG      Peak;
	ULONG      Return;
} EPROCESS_QUOTA_ENTRY, *PEPROCESS_QUOTA_ENTRY;

typedef struct _EPROCESS_QUOTA_BLOCK {
	EPROCESS_QUOTA_ENTRY    QuotaEntry[3];
	LIST_ENTRY              QuotaList;
	ULONG                   ReferenceCount;
	ULONG                   ProcessCount;
} EPROCESS_QUOTA_BLOCK, *PEPROCESS_QUOTA_BLOCK;

typedef struct _HANDLEENTRY{
    PVOID  phead;       
    ULONG  pOwner;      
    BYTE  bType;        
    BYTE  bFlags;       
    WORD  wUniq;       
}HANDLEENTRY,*PHANDLEENTRY;

typedef struct _SERVERINFO{   
    DWORD dwSRVIFlags;
	DWORD cHandleEntries;   
    WORD wSRVIFlags;      
    WORD wRIPPID;         
    WORD wRIPError;

    
}SERVERINFO,*PSERVERINFO;

typedef struct _SHAREDINFO{
    PSERVERINFO psi;      
    PHANDLEENTRY aheList;
	ULONG HeEntrySize; // Win7 - not present in WinXP?
    ULONG_PTR pDispInfo;      
    ULONG_PTR ulSharedDelta;
	ULONG_PTR awmControl; // Not in XP
    ULONG_PTR DefWindowMsgs; // Not in XP
    ULONG_PTR DefWindowSpecMsgs; // Not in XP
}SHAREDINFO,*PSHAREDINFO;

FARPROC NtAllocateVirtualMemory;
FARPROC NtFreeVirtualMemory;

typedef struct ThreadData {
	HWND unicodeWindow;
    HWND ansiWindow;
	HWND ansiKernelWindow;
	ULONG_PTR ptr;
} ThreadData, *PThreadData;

typedef struct _EPROCESS
{
     ULONG_PTR Pcb;
     ULONG_PTR ProcessLock;
     LARGE_INTEGER CreateTime;
     LARGE_INTEGER ExitTime;
     ULONG_PTR RundownProtect;
     PVOID UniqueProcessId;
     LIST_ENTRY ActiveProcessLinks;
     ULONG QuotaUsage[3];
     ULONG QuotaPeak[3];
     ULONG CommitCharge;
     ULONG PeakVirtualSize;
     ULONG VirtualSize;
     LIST_ENTRY SessionProcessLinks;
     PVOID DebugPort;
     union
     {
          PVOID ExceptionPortData;
          ULONG ExceptionPortValue;
          ULONG ExceptionPortState;
     };
     ULONG_PTR ObjectTable;
     ULONG_PTR Token;
     ULONG WorkingSetPage;
     ULONG_PTR AddressCreationLock;
     ULONG_PTR RotateInProgress;
     ULONG_PTR ForkInProgress;
     ULONG HardwareTrigger;
     ULONG_PTR PhysicalVadRoot;
     PVOID CloneRoot;
     ULONG NumberOfPrivatePages;
     ULONG NumberOfLockedPages;
     PVOID Win32Process;
     ULONG_PTR Job;
     PVOID SectionObject;
     PVOID SectionBaseAddress;
     PEPROCESS_QUOTA_BLOCK QuotaBlock;
     ULONG_PTR * WorkingSetWatch;
     PVOID Win32WindowStation;
     PVOID InheritedFromUniqueProcessId;
     PVOID LdtInformation;
     PVOID VadFreeHint;
     PVOID VdmObjects;
     PVOID DeviceMap;
     PVOID EtwDataSource;
     PVOID FreeTebHint;
     union
     {
          ULONG_PTR PageDirectoryPte;
          UINT64 Filler;
     };
     PVOID Session;
     UCHAR ImageFileName[16];
     LIST_ENTRY JobLinks;
     PVOID LockedPagesList;
     LIST_ENTRY ThreadListHead;
     PVOID SecurityPort;
     PVOID PaeTop;
     ULONG ActiveThreads;
     ULONG ImagePathHash;
     ULONG DefaultHardErrorProcessing;
     LONG LastThreadExitStatus;
     ULONG_PTR Peb;
     ULONG_PTR PrefetchTrace;
     LARGE_INTEGER ReadOperationCount;
     LARGE_INTEGER WriteOperationCount;
     LARGE_INTEGER OtherOperationCount;
     LARGE_INTEGER ReadTransferCount;
     LARGE_INTEGER WriteTransferCount;
     LARGE_INTEGER OtherTransferCount;
     ULONG CommitChargeLimit;
     ULONG CommitChargePeak;
     PVOID AweInfo;
     ULONG_PTR SeAuditProcessCreationInfo;
     ULONG_PTR Vm;
     LIST_ENTRY MmProcessLinks;
     ULONG ModifiedPageCount;
     ULONG Flags2;
     ULONG JobNotReallyActive;
     ULONG AccountingFolded;
     ULONG NewProcessReported;
     ULONG ExitProcessReported;
     ULONG ReportCommitChanges;
     ULONG LastReportMemory;
     ULONG ReportPhysicalPageChanges;
     ULONG HandleTableRundown;
     ULONG NeedsHandleRundown;
     ULONG RefTraceEnabled;
     ULONG NumaAware;
     ULONG ProtectedProcess;
     ULONG DefaultPagePriority;
     ULONG PrimaryTokenFrozen;
     ULONG ProcessVerifierTarget;
     ULONG StackRandomizationDisabled;
     ULONG Flags;
     ULONG CreateReported;
     ULONG NoDebugInherit;
     ULONG ProcessExiting;
     ULONG ProcessDelete;
     ULONG Wow64SplitPages;
     ULONG VmDeleted;
     ULONG OutswapEnabled;
     ULONG Outswapped;
     ULONG ForkFailed;
     ULONG Wow64VaSpace4Gb;
     ULONG AddressSpaceInitialized;
     ULONG SetTimerResolution;
     ULONG BreakOnTermination;
     ULONG DeprioritizeViews;
     ULONG WriteWatch;
     ULONG ProcessInSession;
     ULONG OverrideAddressSpace;
     ULONG HasAddressSpace;
     ULONG LaunchPrefetched;
     ULONG InjectInpageErrors;
     ULONG VmTopDown;
     ULONG ImageNotifyDone;
     ULONG PdeUpdateNeeded;
     ULONG VdmAllowed;
     ULONG SmapAllowed;
     ULONG ProcessInserted;
     ULONG DefaultIoPriority;
     ULONG SparePsFlags1;
     LONG ExitStatus;
     WORD Spare7;
     union
     {
          struct
          {
               UCHAR SubSystemMinorVersion;
               UCHAR SubSystemMajorVersion;
          };
          WORD SubSystemVersion;
     };
     UCHAR PriorityClass;
     ULONG_PTR VadRoot;
     ULONG Cookie;
     ULONG_PTR AlpcContext;
}EPROCESS, *PEPROCESS;
